{"ast":null,"code":"'use strict';\n\nvar d3Force = require('d3-force');\nvar interpolateNumber = require('d3-interpolate').interpolateNumber;\nvar d3 = require('@plotly/d3');\nvar d3Sankey = require('@plotly/d3-sankey');\nvar d3SankeyCircular = require('@plotly/d3-sankey-circular');\nvar c = require('./constants');\nvar tinycolor = require('tinycolor2');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar strRotate = Lib.strRotate;\nvar gup = require('../../lib/gup');\nvar keyFun = gup.keyFun;\nvar repeat = gup.repeat;\nvar unwrap = gup.unwrap;\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar Registry = require('../../registry');\nvar alignmentConstants = require('../../constants/alignment');\nvar CAP_SHIFT = alignmentConstants.CAP_SHIFT;\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar TEXTPAD = 3;\n\n// view models\n\nfunction sankeyModel(layout, d, traceIndex) {\n  var calcData = unwrap(d);\n  var trace = calcData.trace;\n  var domain = trace.domain;\n  var horizontal = trace.orientation === 'h';\n  var nodePad = trace.node.pad;\n  var nodeThickness = trace.node.thickness;\n  var width = layout.width * (domain.x[1] - domain.x[0]);\n  var height = layout.height * (domain.y[1] - domain.y[0]);\n  var nodes = calcData._nodes;\n  var links = calcData._links;\n  var circular = calcData.circular;\n\n  // Select Sankey generator\n  var sankey;\n  if (circular) {\n    sankey = d3SankeyCircular.sankeyCircular().circularLinkGap(0);\n  } else {\n    sankey = d3Sankey.sankey();\n  }\n  sankey.iterations(c.sankeyIterations).size(horizontal ? [width, height] : [height, width]).nodeWidth(nodeThickness).nodePadding(nodePad).nodeId(function (d) {\n    return d.pointNumber;\n  }).nodes(nodes).links(links);\n  var graph = sankey();\n  if (sankey.nodePadding() < nodePad) {\n    Lib.warn('node.pad was reduced to ', sankey.nodePadding(), ' to fit within the figure.');\n  }\n\n  // Counters for nested loops\n  var i, j, k;\n\n  // Create transient nodes for animations\n  for (var nodePointNumber in calcData._groupLookup) {\n    var groupIndex = parseInt(calcData._groupLookup[nodePointNumber]);\n\n    // Find node representing groupIndex\n    var groupingNode;\n    for (i = 0; i < graph.nodes.length; i++) {\n      if (graph.nodes[i].pointNumber === groupIndex) {\n        groupingNode = graph.nodes[i];\n        break;\n      }\n    }\n    // If groupinNode is undefined, no links are targeting this group\n    if (!groupingNode) continue;\n    var child = {\n      pointNumber: parseInt(nodePointNumber),\n      x0: groupingNode.x0,\n      x1: groupingNode.x1,\n      y0: groupingNode.y0,\n      y1: groupingNode.y1,\n      partOfGroup: true,\n      sourceLinks: [],\n      targetLinks: []\n    };\n    graph.nodes.unshift(child);\n    groupingNode.childrenNodes.unshift(child);\n  }\n  function computeLinkConcentrations() {\n    for (i = 0; i < graph.nodes.length; i++) {\n      var node = graph.nodes[i];\n      // Links connecting the same two nodes are part of a flow\n      var flows = {};\n      var flowKey;\n      var link;\n      for (j = 0; j < node.targetLinks.length; j++) {\n        link = node.targetLinks[j];\n        flowKey = link.source.pointNumber + ':' + link.target.pointNumber;\n        if (!flows.hasOwnProperty(flowKey)) flows[flowKey] = [];\n        flows[flowKey].push(link);\n      }\n\n      // Compute statistics for each flow\n      var keys = Object.keys(flows);\n      for (j = 0; j < keys.length; j++) {\n        flowKey = keys[j];\n        var flowLinks = flows[flowKey];\n\n        // Find the total size of the flow and total size per label\n        var total = 0;\n        var totalPerLabel = {};\n        for (k = 0; k < flowLinks.length; k++) {\n          link = flowLinks[k];\n          if (!totalPerLabel[link.label]) totalPerLabel[link.label] = 0;\n          totalPerLabel[link.label] += link.value;\n          total += link.value;\n        }\n\n        // Find the ratio of the link's value and the size of the flow\n        for (k = 0; k < flowLinks.length; k++) {\n          link = flowLinks[k];\n          link.flow = {\n            value: total,\n            labelConcentration: totalPerLabel[link.label] / total,\n            concentration: link.value / total,\n            links: flowLinks\n          };\n          if (link.concentrationscale) {\n            link.color = tinycolor(link.concentrationscale(link.flow.labelConcentration));\n          }\n        }\n      }\n\n      // Gather statistics of all links at current node\n      var totalOutflow = 0;\n      for (j = 0; j < node.sourceLinks.length; j++) {\n        totalOutflow += node.sourceLinks[j].value;\n      }\n      for (j = 0; j < node.sourceLinks.length; j++) {\n        link = node.sourceLinks[j];\n        link.concentrationOut = link.value / totalOutflow;\n      }\n      var totalInflow = 0;\n      for (j = 0; j < node.targetLinks.length; j++) {\n        totalInflow += node.targetLinks[j].value;\n      }\n      for (j = 0; j < node.targetLinks.length; j++) {\n        link = node.targetLinks[j];\n        link.concenrationIn = link.value / totalInflow;\n      }\n    }\n  }\n  computeLinkConcentrations();\n\n  // Push any overlapping nodes down.\n  function resolveCollisionsTopToBottom(columns) {\n    columns.forEach(function (nodes) {\n      var node;\n      var dy;\n      var y = 0;\n      var n = nodes.length;\n      var i;\n      nodes.sort(function (a, b) {\n        return a.y0 - b.y0;\n      });\n      for (i = 0; i < n; ++i) {\n        node = nodes[i];\n        if (node.y0 >= y) {\n          // No overlap\n        } else {\n          dy = y - node.y0;\n          if (dy > 1e-6) node.y0 += dy, node.y1 += dy;\n        }\n        y = node.y1 + nodePad;\n      }\n    });\n  }\n\n  // Group nodes into columns based on their x position\n  function snapToColumns(nodes) {\n    // Sort nodes by x position\n    var orderedNodes = nodes.map(function (n, i) {\n      return {\n        x0: n.x0,\n        index: i\n      };\n    }).sort(function (a, b) {\n      return a.x0 - b.x0;\n    });\n    var columns = [];\n    var colNumber = -1;\n    var colX; // Position of column\n    var lastX = -Infinity; // Position of last node\n    var dx;\n    for (i = 0; i < orderedNodes.length; i++) {\n      var node = nodes[orderedNodes[i].index];\n      // If the node does not overlap with the last one\n      if (node.x0 > lastX + nodeThickness) {\n        // Start a new column\n        colNumber += 1;\n        colX = node.x0;\n      }\n      lastX = node.x0;\n\n      // Add node to its associated column\n      if (!columns[colNumber]) columns[colNumber] = [];\n      columns[colNumber].push(node);\n\n      // Change node's x position to align it with its column\n      dx = colX - node.x0;\n      node.x0 += dx, node.x1 += dx;\n    }\n    return columns;\n  }\n\n  // Force node position\n  if (trace.node.x.length && trace.node.y.length) {\n    for (i = 0; i < Math.min(trace.node.x.length, trace.node.y.length, graph.nodes.length); i++) {\n      if (trace.node.x[i] && trace.node.y[i]) {\n        var pos = [trace.node.x[i] * width, trace.node.y[i] * height];\n        graph.nodes[i].x0 = pos[0] - nodeThickness / 2;\n        graph.nodes[i].x1 = pos[0] + nodeThickness / 2;\n        var nodeHeight = graph.nodes[i].y1 - graph.nodes[i].y0;\n        graph.nodes[i].y0 = pos[1] - nodeHeight / 2;\n        graph.nodes[i].y1 = pos[1] + nodeHeight / 2;\n      }\n    }\n    if (trace.arrangement === 'snap') {\n      nodes = graph.nodes;\n      var columns = snapToColumns(nodes);\n      resolveCollisionsTopToBottom(columns);\n    }\n    // Update links\n    sankey.update(graph);\n  }\n  return {\n    circular: circular,\n    key: traceIndex,\n    trace: trace,\n    guid: Lib.randstr(),\n    horizontal: horizontal,\n    width: width,\n    height: height,\n    nodePad: trace.node.pad,\n    nodeLineColor: trace.node.line.color,\n    nodeLineWidth: trace.node.line.width,\n    linkLineColor: trace.link.line.color,\n    linkLineWidth: trace.link.line.width,\n    linkArrowLength: trace.link.arrowlen,\n    valueFormat: trace.valueformat,\n    valueSuffix: trace.valuesuffix,\n    textFont: trace.textfont,\n    translateX: domain.x[0] * layout.width + layout.margin.l,\n    translateY: layout.height - domain.y[1] * layout.height + layout.margin.t,\n    dragParallel: horizontal ? height : width,\n    dragPerpendicular: horizontal ? width : height,\n    arrangement: trace.arrangement,\n    sankey: sankey,\n    graph: graph,\n    forceLayouts: {},\n    interactionState: {\n      dragInProgress: false,\n      hovered: false\n    }\n  };\n}\nfunction linkModel(d, l, i) {\n  var tc = tinycolor(l.color);\n  var basicKey = l.source.label + '|' + l.target.label;\n  var key = basicKey + '__' + i;\n\n  // for event data\n  l.trace = d.trace;\n  l.curveNumber = d.trace.index;\n  return {\n    circular: d.circular,\n    key: key,\n    traceId: d.key,\n    pointNumber: l.pointNumber,\n    link: l,\n    tinyColorHue: Color.tinyRGB(tc),\n    tinyColorAlpha: tc.getAlpha(),\n    linkPath: linkPath,\n    linkLineColor: d.linkLineColor,\n    linkLineWidth: d.linkLineWidth,\n    linkArrowLength: d.linkArrowLength,\n    valueFormat: d.valueFormat,\n    valueSuffix: d.valueSuffix,\n    sankey: d.sankey,\n    parent: d,\n    interactionState: d.interactionState,\n    flow: l.flow\n  };\n}\nfunction createCircularClosedPathString(link, arrowLen) {\n  // Using coordinates computed by d3-sankey-circular\n  var pathString = '';\n  var offset = link.width / 2;\n  var coords = link.circularPathData;\n  if (link.circularLinkType === 'top') {\n    // Top path\n    pathString =\n    // start at the left of the target node\n    'M ' + (coords.targetX - arrowLen) + ' ' + (coords.targetY + offset) + ' ' + 'L' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY + offset) + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 1 ' + (coords.rightFullExtent - offset - arrowLen) + ' ' + (coords.targetY - coords.rightSmallArcRadius) + 'L' + (coords.rightFullExtent - offset - arrowLen) + ' ' + coords.verticalRightInnerExtent + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 1 ' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent - offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 1 ' + (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent + 'L' + (coords.leftFullExtent + offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 1 ' + coords.leftInnerExtent + ' ' + (coords.sourceY + offset) + 'L' + coords.sourceX + ' ' + (coords.sourceY + offset) +\n    // Walking back\n    'L' + coords.sourceX + ' ' + (coords.sourceY - offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.sourceY - offset) + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 0 ' + (coords.leftFullExtent - offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) + 'L' + (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 0 ' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) + 'L' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent + offset) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 0 ' + (coords.rightFullExtent + offset - arrowLen) + ' ' + coords.verticalRightInnerExtent + 'L' + (coords.rightFullExtent + offset - arrowLen) + ' ' + (coords.targetY - coords.rightSmallArcRadius) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 0 ' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY - offset) + 'L' + (coords.targetX - arrowLen) + ' ' + (coords.targetY - offset) + (arrowLen > 0 ? 'L' + coords.targetX + ' ' + coords.targetY : '') + 'Z';\n  } else {\n    // Bottom path\n    pathString =\n    // start at the left of the target node\n    'M ' + (coords.targetX - arrowLen) + ' ' + (coords.targetY - offset) + ' ' + 'L' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY - offset) + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 0 ' + (coords.rightFullExtent - offset - arrowLen) + ' ' + (coords.targetY + coords.rightSmallArcRadius) + 'L' + (coords.rightFullExtent - offset - arrowLen) + ' ' + coords.verticalRightInnerExtent + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 0 ' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent + offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 0 ' + (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent + 'L' + (coords.leftFullExtent + offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 0 ' + coords.leftInnerExtent + ' ' + (coords.sourceY - offset) + 'L' + coords.sourceX + ' ' + (coords.sourceY - offset) +\n    // Walking back\n    'L' + coords.sourceX + ' ' + (coords.sourceY + offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.sourceY + offset) + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 1 ' + (coords.leftFullExtent - offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) + 'L' + (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 1 ' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) + 'L' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent - offset) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 1 ' + (coords.rightFullExtent + offset - arrowLen) + ' ' + coords.verticalRightInnerExtent + 'L' + (coords.rightFullExtent + offset - arrowLen) + ' ' + (coords.targetY + coords.rightSmallArcRadius) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 1 ' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY + offset) + 'L' + (coords.targetX - arrowLen) + ' ' + (coords.targetY + offset) + (arrowLen > 0 ? 'L' + coords.targetX + ' ' + coords.targetY : '') + 'Z';\n  }\n  return pathString;\n}\nfunction linkPath() {\n  var curvature = 0.5;\n  function path(d) {\n    var arrowLen = d.linkArrowLength;\n    if (d.link.circular) {\n      return createCircularClosedPathString(d.link, arrowLen);\n    } else {\n      var maxArrowLength = Math.abs((d.link.target.x0 - d.link.source.x1) / 2);\n      if (arrowLen > maxArrowLength) {\n        arrowLen = maxArrowLength;\n      }\n      var x0 = d.link.source.x1;\n      var x1 = d.link.target.x0 - arrowLen;\n      var xi = interpolateNumber(x0, x1);\n      var x2 = xi(curvature);\n      var x3 = xi(1 - curvature);\n      var y0a = d.link.y0 - d.link.width / 2;\n      var y0b = d.link.y0 + d.link.width / 2;\n      var y1a = d.link.y1 - d.link.width / 2;\n      var y1b = d.link.y1 + d.link.width / 2;\n      var start = 'M' + x0 + ',' + y0a;\n      var upperCurve = 'C' + x2 + ',' + y0a + ' ' + x3 + ',' + y1a + ' ' + x1 + ',' + y1a;\n      var lowerCurve = 'C' + x3 + ',' + y1b + ' ' + x2 + ',' + y0b + ' ' + x0 + ',' + y0b;\n      var rightEnd = arrowLen > 0 ? 'L' + (x1 + arrowLen) + ',' + (y1a + d.link.width / 2) : '';\n      rightEnd += 'L' + x1 + ',' + y1b;\n      return start + upperCurve + rightEnd + lowerCurve + 'Z';\n    }\n  }\n  return path;\n}\nfunction nodeModel(d, n) {\n  var tc = tinycolor(n.color);\n  var zoneThicknessPad = c.nodePadAcross;\n  var zoneLengthPad = d.nodePad / 2;\n  n.dx = n.x1 - n.x0;\n  n.dy = n.y1 - n.y0;\n  var visibleThickness = n.dx;\n  var visibleLength = Math.max(0.5, n.dy);\n  var key = 'node_' + n.pointNumber;\n  // If it's a group, it's mutable and should be unique\n  if (n.group) {\n    key = Lib.randstr();\n  }\n\n  // for event data\n  n.trace = d.trace;\n  n.curveNumber = d.trace.index;\n  return {\n    index: n.pointNumber,\n    key: key,\n    partOfGroup: n.partOfGroup || false,\n    group: n.group,\n    traceId: d.key,\n    trace: d.trace,\n    node: n,\n    nodePad: d.nodePad,\n    nodeLineColor: d.nodeLineColor,\n    nodeLineWidth: d.nodeLineWidth,\n    textFont: d.textFont,\n    size: d.horizontal ? d.height : d.width,\n    visibleWidth: Math.ceil(visibleThickness),\n    visibleHeight: visibleLength,\n    zoneX: -zoneThicknessPad,\n    zoneY: -zoneLengthPad,\n    zoneWidth: visibleThickness + 2 * zoneThicknessPad,\n    zoneHeight: visibleLength + 2 * zoneLengthPad,\n    labelY: d.horizontal ? n.dy / 2 + 1 : n.dx / 2 + 1,\n    left: n.originalLayer === 1,\n    sizeAcross: d.width,\n    forceLayouts: d.forceLayouts,\n    horizontal: d.horizontal,\n    darkBackground: tc.getBrightness() <= 128,\n    tinyColorHue: Color.tinyRGB(tc),\n    tinyColorAlpha: tc.getAlpha(),\n    valueFormat: d.valueFormat,\n    valueSuffix: d.valueSuffix,\n    sankey: d.sankey,\n    graph: d.graph,\n    arrangement: d.arrangement,\n    uniqueNodeLabelPathId: [d.guid, d.key, key].join('_'),\n    interactionState: d.interactionState,\n    figure: d\n  };\n}\n\n// rendering snippets\n\nfunction updateNodePositions(sankeyNode) {\n  sankeyNode.attr('transform', function (d) {\n    return strTranslate(d.node.x0.toFixed(3), d.node.y0.toFixed(3));\n  });\n}\nfunction updateNodeShapes(sankeyNode) {\n  sankeyNode.call(updateNodePositions);\n}\nfunction updateShapes(sankeyNode, sankeyLink) {\n  sankeyNode.call(updateNodeShapes);\n  sankeyLink.attr('d', linkPath());\n}\nfunction sizeNode(rect) {\n  rect.attr('width', function (d) {\n    return d.node.x1 - d.node.x0;\n  }).attr('height', function (d) {\n    return d.visibleHeight;\n  });\n}\nfunction salientEnough(d) {\n  return d.link.width > 1 || d.linkLineWidth > 0;\n}\nfunction sankeyTransform(d) {\n  var offset = strTranslate(d.translateX, d.translateY);\n  return offset + (d.horizontal ? 'matrix(1 0 0 1 0 0)' : 'matrix(0 1 1 0 0 0)');\n}\n\n// event handling\n\nfunction attachPointerEvents(selection, sankey, eventSet) {\n  selection.on('.basic', null) // remove any preexisting handlers\n  .on('mouseover.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.hover(this, d, sankey);\n      d.interactionState.hovered = [this, d];\n    }\n  }).on('mousemove.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.follow(this, d);\n      d.interactionState.hovered = [this, d];\n    }\n  }).on('mouseout.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.unhover(this, d, sankey);\n      d.interactionState.hovered = false;\n    }\n  }).on('click.basic', function (d) {\n    if (d.interactionState.hovered) {\n      eventSet.unhover(this, d, sankey);\n      d.interactionState.hovered = false;\n    }\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.select(this, d, sankey);\n    }\n  });\n}\nfunction attachDragHandler(sankeyNode, sankeyLink, callbacks, gd) {\n  var dragBehavior = d3.behavior.drag().origin(function (d) {\n    return {\n      x: d.node.x0 + d.visibleWidth / 2,\n      y: d.node.y0 + d.visibleHeight / 2\n    };\n  }).on('dragstart', function (d) {\n    if (d.arrangement === 'fixed') return;\n    Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'dragcover', function (s) {\n      gd._fullLayout._dragCover = s;\n    });\n    Lib.raiseToTop(this);\n    d.interactionState.dragInProgress = d.node;\n    saveCurrentDragPosition(d.node);\n    if (d.interactionState.hovered) {\n      callbacks.nodeEvents.unhover.apply(0, d.interactionState.hovered);\n      d.interactionState.hovered = false;\n    }\n    if (d.arrangement === 'snap') {\n      var forceKey = d.traceId + '|' + d.key;\n      if (d.forceLayouts[forceKey]) {\n        d.forceLayouts[forceKey].alpha(1);\n      } else {\n        // make a forceLayout if needed\n        attachForce(sankeyNode, forceKey, d, gd);\n      }\n      startForce(sankeyNode, sankeyLink, d, forceKey, gd);\n    }\n  }).on('drag', function (d) {\n    if (d.arrangement === 'fixed') return;\n    var x = d3.event.x;\n    var y = d3.event.y;\n    if (d.arrangement === 'snap') {\n      d.node.x0 = x - d.visibleWidth / 2;\n      d.node.x1 = x + d.visibleWidth / 2;\n      d.node.y0 = y - d.visibleHeight / 2;\n      d.node.y1 = y + d.visibleHeight / 2;\n    } else {\n      if (d.arrangement === 'freeform') {\n        d.node.x0 = x - d.visibleWidth / 2;\n        d.node.x1 = x + d.visibleWidth / 2;\n      }\n      y = Math.max(0, Math.min(d.size - d.visibleHeight / 2, y));\n      d.node.y0 = y - d.visibleHeight / 2;\n      d.node.y1 = y + d.visibleHeight / 2;\n    }\n    saveCurrentDragPosition(d.node);\n    if (d.arrangement !== 'snap') {\n      d.sankey.update(d.graph);\n      updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n    }\n  }).on('dragend', function (d) {\n    if (d.arrangement === 'fixed') return;\n    d.interactionState.dragInProgress = false;\n    for (var i = 0; i < d.node.childrenNodes.length; i++) {\n      d.node.childrenNodes[i].x = d.node.x;\n      d.node.childrenNodes[i].y = d.node.y;\n    }\n    if (d.arrangement !== 'snap') persistFinalNodePositions(d, gd);\n  });\n  sankeyNode.on('.drag', null) // remove possible previous handlers\n  .call(dragBehavior);\n}\nfunction attachForce(sankeyNode, forceKey, d, gd) {\n  // Attach force to nodes in the same column (same x coordinate)\n  switchToForceFormat(d.graph.nodes);\n  var nodes = d.graph.nodes.filter(function (n) {\n    return n.originalX === d.node.originalX;\n  })\n  // Filter out children\n  .filter(function (n) {\n    return !n.partOfGroup;\n  });\n  d.forceLayouts[forceKey] = d3Force.forceSimulation(nodes).alphaDecay(0).force('collide', d3Force.forceCollide().radius(function (n) {\n    return n.dy / 2 + d.nodePad / 2;\n  }).strength(1).iterations(c.forceIterations)).force('constrain', snappingForce(sankeyNode, forceKey, nodes, d, gd)).stop();\n}\nfunction startForce(sankeyNode, sankeyLink, d, forceKey, gd) {\n  window.requestAnimationFrame(function faster() {\n    var i;\n    for (i = 0; i < c.forceTicksPerFrame; i++) {\n      d.forceLayouts[forceKey].tick();\n    }\n    var nodes = d.graph.nodes;\n    switchToSankeyFormat(nodes);\n    d.sankey.update(d.graph);\n    updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n    if (d.forceLayouts[forceKey].alpha() > 0) {\n      window.requestAnimationFrame(faster);\n    } else {\n      // Make sure the final x position is equal to its original value\n      // because the force simulation will have numerical error\n      var x = d.node.originalX;\n      d.node.x0 = x - d.visibleWidth / 2;\n      d.node.x1 = x + d.visibleWidth / 2;\n      persistFinalNodePositions(d, gd);\n    }\n  });\n}\nfunction snappingForce(sankeyNode, forceKey, nodes, d) {\n  return function _snappingForce() {\n    var maxVelocity = 0;\n    for (var i = 0; i < nodes.length; i++) {\n      var n = nodes[i];\n      if (n === d.interactionState.dragInProgress) {\n        // constrain node position to the dragging pointer\n        n.x = n.lastDraggedX;\n        n.y = n.lastDraggedY;\n      } else {\n        n.vx = (n.originalX - n.x) / c.forceTicksPerFrame; // snap to layer\n        n.y = Math.min(d.size - n.dy / 2, Math.max(n.dy / 2, n.y)); // constrain to extent\n      }\n\n      maxVelocity = Math.max(maxVelocity, Math.abs(n.vx), Math.abs(n.vy));\n    }\n    if (!d.interactionState.dragInProgress && maxVelocity < 0.1 && d.forceLayouts[forceKey].alpha() > 0) {\n      d.forceLayouts[forceKey].alpha(0); // This will stop the animation loop\n    }\n  };\n}\n\n// basic data utilities\n\nfunction persistFinalNodePositions(d, gd) {\n  var x = [];\n  var y = [];\n  for (var i = 0; i < d.graph.nodes.length; i++) {\n    var nodeX = (d.graph.nodes[i].x0 + d.graph.nodes[i].x1) / 2;\n    var nodeY = (d.graph.nodes[i].y0 + d.graph.nodes[i].y1) / 2;\n    x.push(nodeX / d.figure.width);\n    y.push(nodeY / d.figure.height);\n  }\n  Registry.call('_guiRestyle', gd, {\n    'node.x': [x],\n    'node.y': [y]\n  }, d.trace.index).then(function () {\n    if (gd._fullLayout._dragCover) gd._fullLayout._dragCover.remove();\n  });\n}\nfunction persistOriginalPlace(nodes) {\n  var distinctLayerPositions = [];\n  var i;\n  for (i = 0; i < nodes.length; i++) {\n    nodes[i].originalX = (nodes[i].x0 + nodes[i].x1) / 2;\n    nodes[i].originalY = (nodes[i].y0 + nodes[i].y1) / 2;\n    if (distinctLayerPositions.indexOf(nodes[i].originalX) === -1) {\n      distinctLayerPositions.push(nodes[i].originalX);\n    }\n  }\n  distinctLayerPositions.sort(function (a, b) {\n    return a - b;\n  });\n  for (i = 0; i < nodes.length; i++) {\n    nodes[i].originalLayerIndex = distinctLayerPositions.indexOf(nodes[i].originalX);\n    nodes[i].originalLayer = nodes[i].originalLayerIndex / (distinctLayerPositions.length - 1);\n  }\n}\nfunction saveCurrentDragPosition(d) {\n  d.lastDraggedX = d.x0 + d.dx / 2;\n  d.lastDraggedY = d.y0 + d.dy / 2;\n}\nfunction sameLayer(d) {\n  return function (n) {\n    return n.node.originalX === d.node.originalX;\n  };\n}\nfunction switchToForceFormat(nodes) {\n  // force uses x, y as centers\n  for (var i = 0; i < nodes.length; i++) {\n    nodes[i].y = (nodes[i].y0 + nodes[i].y1) / 2;\n    nodes[i].x = (nodes[i].x0 + nodes[i].x1) / 2;\n  }\n}\nfunction switchToSankeyFormat(nodes) {\n  // sankey uses x0, x1, y0, y1\n  for (var i = 0; i < nodes.length; i++) {\n    nodes[i].y0 = nodes[i].y - nodes[i].dy / 2;\n    nodes[i].y1 = nodes[i].y0 + nodes[i].dy;\n    nodes[i].x0 = nodes[i].x - nodes[i].dx / 2;\n    nodes[i].x1 = nodes[i].x0 + nodes[i].dx;\n  }\n}\n\n// scene graph\nmodule.exports = function (gd, svg, calcData, layout, callbacks) {\n  var isStatic = gd._context.staticPlot;\n\n  // To prevent animation on first render\n  var firstRender = false;\n  Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'first-render', function () {\n    firstRender = true;\n  });\n\n  // To prevent animation on dragging\n  var dragcover = gd._fullLayout._dragCover;\n  var styledData = calcData.filter(function (d) {\n    return unwrap(d).trace.visible;\n  }).map(sankeyModel.bind(null, layout));\n  var sankey = svg.selectAll('.' + c.cn.sankey).data(styledData, keyFun);\n  sankey.exit().remove();\n  sankey.enter().append('g').classed(c.cn.sankey, true).style('box-sizing', 'content-box').style('position', 'absolute').style('left', 0).style('shape-rendering', 'geometricPrecision').style('pointer-events', isStatic ? 'none' : 'auto').attr('transform', sankeyTransform);\n  sankey.each(function (d, i) {\n    gd._fullData[i]._sankey = d;\n    // Create dragbox if missing\n    var dragboxClassName = 'bgsankey-' + d.trace.uid + '-' + i;\n    Lib.ensureSingle(gd._fullLayout._draggers, 'rect', dragboxClassName);\n    gd._fullData[i]._bgRect = d3.select('.' + dragboxClassName);\n\n    // Style dragbox\n    gd._fullData[i]._bgRect.style('pointer-events', isStatic ? 'none' : 'all').attr('width', d.width).attr('height', d.height).attr('x', d.translateX).attr('y', d.translateY).classed('bgsankey', true).style({\n      fill: 'transparent',\n      'stroke-width': 0\n    });\n  });\n  sankey.transition().ease(c.ease).duration(c.duration).attr('transform', sankeyTransform);\n  var sankeyLinks = sankey.selectAll('.' + c.cn.sankeyLinks).data(repeat, keyFun);\n  sankeyLinks.enter().append('g').classed(c.cn.sankeyLinks, true).style('fill', 'none');\n  var sankeyLink = sankeyLinks.selectAll('.' + c.cn.sankeyLink).data(function (d) {\n    var links = d.graph.links;\n    return links.filter(function (l) {\n      return l.value;\n    }).map(linkModel.bind(null, d));\n  }, keyFun);\n  sankeyLink.enter().append('path').classed(c.cn.sankeyLink, true).call(attachPointerEvents, sankey, callbacks.linkEvents);\n  sankeyLink.style('stroke', function (d) {\n    return salientEnough(d) ? Color.tinyRGB(tinycolor(d.linkLineColor)) : d.tinyColorHue;\n  }).style('stroke-opacity', function (d) {\n    return salientEnough(d) ? Color.opacity(d.linkLineColor) : d.tinyColorAlpha;\n  }).style('fill', function (d) {\n    return d.tinyColorHue;\n  }).style('fill-opacity', function (d) {\n    return d.tinyColorAlpha;\n  }).style('stroke-width', function (d) {\n    return salientEnough(d) ? d.linkLineWidth : 1;\n  }).attr('d', linkPath());\n  sankeyLink.style('opacity', function () {\n    return gd._context.staticPlot || firstRender || dragcover ? 1 : 0;\n  }).transition().ease(c.ease).duration(c.duration).style('opacity', 1);\n  sankeyLink.exit().transition().ease(c.ease).duration(c.duration).style('opacity', 0).remove();\n  var sankeyNodeSet = sankey.selectAll('.' + c.cn.sankeyNodeSet).data(repeat, keyFun);\n  sankeyNodeSet.enter().append('g').classed(c.cn.sankeyNodeSet, true);\n  sankeyNodeSet.style('cursor', function (d) {\n    switch (d.arrangement) {\n      case 'fixed':\n        return 'default';\n      case 'perpendicular':\n        return 'ns-resize';\n      default:\n        return 'move';\n    }\n  });\n  var sankeyNode = sankeyNodeSet.selectAll('.' + c.cn.sankeyNode).data(function (d) {\n    var nodes = d.graph.nodes;\n    persistOriginalPlace(nodes);\n    return nodes.map(nodeModel.bind(null, d));\n  }, keyFun);\n  sankeyNode.enter().append('g').classed(c.cn.sankeyNode, true).call(updateNodePositions).style('opacity', function (n) {\n    return (gd._context.staticPlot || firstRender) && !n.partOfGroup ? 1 : 0;\n  });\n  sankeyNode.call(attachPointerEvents, sankey, callbacks.nodeEvents).call(attachDragHandler, sankeyLink, callbacks, gd); // has to be here as it binds sankeyLink\n\n  sankeyNode.transition().ease(c.ease).duration(c.duration).call(updateNodePositions).style('opacity', function (n) {\n    return n.partOfGroup ? 0 : 1;\n  });\n  sankeyNode.exit().transition().ease(c.ease).duration(c.duration).style('opacity', 0).remove();\n  var nodeRect = sankeyNode.selectAll('.' + c.cn.nodeRect).data(repeat);\n  nodeRect.enter().append('rect').classed(c.cn.nodeRect, true).call(sizeNode);\n  nodeRect.style('stroke-width', function (d) {\n    return d.nodeLineWidth;\n  }).style('stroke', function (d) {\n    return Color.tinyRGB(tinycolor(d.nodeLineColor));\n  }).style('stroke-opacity', function (d) {\n    return Color.opacity(d.nodeLineColor);\n  }).style('fill', function (d) {\n    return d.tinyColorHue;\n  }).style('fill-opacity', function (d) {\n    return d.tinyColorAlpha;\n  });\n  nodeRect.transition().ease(c.ease).duration(c.duration).call(sizeNode);\n  var nodeLabel = sankeyNode.selectAll('.' + c.cn.nodeLabel).data(repeat);\n  nodeLabel.enter().append('text').classed(c.cn.nodeLabel, true).style('cursor', 'default');\n  nodeLabel.attr('data-notex', 1) // prohibit tex interpretation until we can handle tex and regular text together\n  .text(function (d) {\n    return d.node.label;\n  }).each(function (d) {\n    var e = d3.select(this);\n    Drawing.font(e, d.textFont);\n    svgTextUtils.convertToTspans(e, gd);\n  }).style('text-shadow', svgTextUtils.makeTextShadow(gd._fullLayout.paper_bgcolor)).attr('text-anchor', function (d) {\n    return d.horizontal && d.left ? 'end' : 'start';\n  }).attr('transform', function (d) {\n    var e = d3.select(this);\n    // how much to shift a multi-line label to center it vertically.\n    var nLines = svgTextUtils.lineCount(e);\n    var blockHeight = d.textFont.size * ((nLines - 1) * LINE_SPACING - CAP_SHIFT);\n    var posX = d.nodeLineWidth / 2 + TEXTPAD;\n    var posY = ((d.horizontal ? d.visibleHeight : d.visibleWidth) - blockHeight) / 2;\n    if (d.horizontal) {\n      if (d.left) {\n        posX = -posX;\n      } else {\n        posX += d.visibleWidth;\n      }\n    }\n    var flipText = d.horizontal ? '' : 'scale(-1,1)' + strRotate(90);\n    return strTranslate(d.horizontal ? posX : posY, d.horizontal ? posY : posX) + flipText;\n  });\n  nodeLabel.transition().ease(c.ease).duration(c.duration);\n};","map":{"version":3,"names":["d3Force","require","interpolateNumber","d3","d3Sankey","d3SankeyCircular","c","tinycolor","Color","Drawing","Lib","strTranslate","strRotate","gup","keyFun","repeat","unwrap","svgTextUtils","Registry","alignmentConstants","CAP_SHIFT","LINE_SPACING","TEXTPAD","sankeyModel","layout","d","traceIndex","calcData","trace","domain","horizontal","orientation","nodePad","node","pad","nodeThickness","thickness","width","x","height","y","nodes","_nodes","links","_links","circular","sankey","sankeyCircular","circularLinkGap","iterations","sankeyIterations","size","nodeWidth","nodePadding","nodeId","pointNumber","graph","warn","i","j","k","nodePointNumber","_groupLookup","groupIndex","parseInt","groupingNode","length","child","x0","x1","y0","y1","partOfGroup","sourceLinks","targetLinks","unshift","childrenNodes","computeLinkConcentrations","flows","flowKey","link","source","target","hasOwnProperty","push","keys","Object","flowLinks","total","totalPerLabel","label","value","flow","labelConcentration","concentration","concentrationscale","color","totalOutflow","concentrationOut","totalInflow","concenrationIn","resolveCollisionsTopToBottom","columns","forEach","dy","n","sort","a","b","snapToColumns","orderedNodes","map","index","colNumber","colX","lastX","Infinity","dx","Math","min","pos","nodeHeight","arrangement","update","key","guid","randstr","nodeLineColor","line","nodeLineWidth","linkLineColor","linkLineWidth","linkArrowLength","arrowlen","valueFormat","valueformat","valueSuffix","valuesuffix","textFont","textfont","translateX","margin","l","translateY","t","dragParallel","dragPerpendicular","forceLayouts","interactionState","dragInProgress","hovered","linkModel","tc","basicKey","curveNumber","traceId","tinyColorHue","tinyRGB","tinyColorAlpha","getAlpha","linkPath","parent","createCircularClosedPathString","arrowLen","pathString","offset","coords","circularPathData","circularLinkType","targetX","targetY","rightInnerExtent","rightLargeArcRadius","rightSmallArcRadius","rightFullExtent","verticalRightInnerExtent","verticalFullExtent","leftInnerExtent","leftLargeArcRadius","leftFullExtent","verticalLeftInnerExtent","sourceY","leftSmallArcRadius","sourceX","curvature","path","maxArrowLength","abs","xi","x2","x3","y0a","y0b","y1a","y1b","start","upperCurve","lowerCurve","rightEnd","nodeModel","zoneThicknessPad","nodePadAcross","zoneLengthPad","visibleThickness","visibleLength","max","group","visibleWidth","ceil","visibleHeight","zoneX","zoneY","zoneWidth","zoneHeight","labelY","left","originalLayer","sizeAcross","darkBackground","getBrightness","uniqueNodeLabelPathId","join","figure","updateNodePositions","sankeyNode","attr","toFixed","updateNodeShapes","call","updateShapes","sankeyLink","sizeNode","rect","salientEnough","sankeyTransform","attachPointerEvents","selection","eventSet","on","hover","follow","unhover","select","attachDragHandler","callbacks","gd","dragBehavior","behavior","drag","origin","ensureSingle","_fullLayout","_infolayer","s","_dragCover","raiseToTop","saveCurrentDragPosition","nodeEvents","apply","forceKey","alpha","attachForce","startForce","event","filter","sameLayer","persistFinalNodePositions","switchToForceFormat","originalX","forceSimulation","alphaDecay","force","forceCollide","radius","strength","forceIterations","snappingForce","stop","window","requestAnimationFrame","faster","forceTicksPerFrame","tick","switchToSankeyFormat","_snappingForce","maxVelocity","lastDraggedX","lastDraggedY","vx","vy","nodeX","nodeY","then","remove","persistOriginalPlace","distinctLayerPositions","originalY","indexOf","originalLayerIndex","module","exports","svg","isStatic","_context","staticPlot","firstRender","dragcover","styledData","visible","bind","selectAll","cn","data","exit","enter","append","classed","style","each","_fullData","_sankey","dragboxClassName","uid","_draggers","_bgRect","fill","transition","ease","duration","sankeyLinks","linkEvents","opacity","sankeyNodeSet","nodeRect","nodeLabel","text","e","font","convertToTspans","makeTextShadow","paper_bgcolor","nLines","lineCount","blockHeight","posX","posY","flipText"],"sources":["/Users/lordvoldemort/django_react/second_attempt/frontend/bull_bear/node_modules/plotly.js/src/traces/sankey/render.js"],"sourcesContent":["'use strict';\n\nvar d3Force = require('d3-force');\nvar interpolateNumber = require('d3-interpolate').interpolateNumber;\nvar d3 = require('@plotly/d3');\nvar d3Sankey = require('@plotly/d3-sankey');\nvar d3SankeyCircular = require('@plotly/d3-sankey-circular');\n\nvar c = require('./constants');\nvar tinycolor = require('tinycolor2');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar strRotate = Lib.strRotate;\nvar gup = require('../../lib/gup');\nvar keyFun = gup.keyFun;\nvar repeat = gup.repeat;\nvar unwrap = gup.unwrap;\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar Registry = require('../../registry');\n\nvar alignmentConstants = require('../../constants/alignment');\nvar CAP_SHIFT = alignmentConstants.CAP_SHIFT;\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar TEXTPAD = 3;\n\n// view models\n\nfunction sankeyModel(layout, d, traceIndex) {\n    var calcData = unwrap(d);\n    var trace = calcData.trace;\n    var domain = trace.domain;\n    var horizontal = trace.orientation === 'h';\n    var nodePad = trace.node.pad;\n    var nodeThickness = trace.node.thickness;\n\n    var width = layout.width * (domain.x[1] - domain.x[0]);\n    var height = layout.height * (domain.y[1] - domain.y[0]);\n\n    var nodes = calcData._nodes;\n    var links = calcData._links;\n    var circular = calcData.circular;\n\n    // Select Sankey generator\n    var sankey;\n    if(circular) {\n        sankey = d3SankeyCircular\n            .sankeyCircular()\n            .circularLinkGap(0);\n    } else {\n        sankey = d3Sankey.sankey();\n    }\n\n    sankey\n      .iterations(c.sankeyIterations)\n      .size(horizontal ? [width, height] : [height, width])\n      .nodeWidth(nodeThickness)\n      .nodePadding(nodePad)\n      .nodeId(function(d) {\n          return d.pointNumber;\n      })\n      .nodes(nodes)\n      .links(links);\n\n    var graph = sankey();\n\n    if(sankey.nodePadding() < nodePad) {\n        Lib.warn('node.pad was reduced to ', sankey.nodePadding(), ' to fit within the figure.');\n    }\n\n    // Counters for nested loops\n    var i, j, k;\n\n    // Create transient nodes for animations\n    for(var nodePointNumber in calcData._groupLookup) {\n        var groupIndex = parseInt(calcData._groupLookup[nodePointNumber]);\n\n        // Find node representing groupIndex\n        var groupingNode;\n\n        for(i = 0; i < graph.nodes.length; i++) {\n            if(graph.nodes[i].pointNumber === groupIndex) {\n                groupingNode = graph.nodes[i];\n                break;\n            }\n        }\n        // If groupinNode is undefined, no links are targeting this group\n        if(!groupingNode) continue;\n\n        var child = {\n            pointNumber: parseInt(nodePointNumber),\n            x0: groupingNode.x0,\n            x1: groupingNode.x1,\n            y0: groupingNode.y0,\n            y1: groupingNode.y1,\n            partOfGroup: true,\n            sourceLinks: [],\n            targetLinks: []\n        };\n\n        graph.nodes.unshift(child);\n        groupingNode.childrenNodes.unshift(child);\n    }\n\n    function computeLinkConcentrations() {\n        for(i = 0; i < graph.nodes.length; i++) {\n            var node = graph.nodes[i];\n            // Links connecting the same two nodes are part of a flow\n            var flows = {};\n            var flowKey;\n            var link;\n            for(j = 0; j < node.targetLinks.length; j++) {\n                link = node.targetLinks[j];\n                flowKey = link.source.pointNumber + ':' + link.target.pointNumber;\n                if(!flows.hasOwnProperty(flowKey)) flows[flowKey] = [];\n                flows[flowKey].push(link);\n            }\n\n            // Compute statistics for each flow\n            var keys = Object.keys(flows);\n            for(j = 0; j < keys.length; j++) {\n                flowKey = keys[j];\n                var flowLinks = flows[flowKey];\n\n                // Find the total size of the flow and total size per label\n                var total = 0;\n                var totalPerLabel = {};\n                for(k = 0; k < flowLinks.length; k++) {\n                    link = flowLinks[k];\n                    if(!totalPerLabel[link.label]) totalPerLabel[link.label] = 0;\n                    totalPerLabel[link.label] += link.value;\n                    total += link.value;\n                }\n\n                // Find the ratio of the link's value and the size of the flow\n                for(k = 0; k < flowLinks.length; k++) {\n                    link = flowLinks[k];\n                    link.flow = {\n                        value: total,\n                        labelConcentration: totalPerLabel[link.label] / total,\n                        concentration: link.value / total,\n                        links: flowLinks\n                    };\n                    if(link.concentrationscale) {\n                        link.color = tinycolor(link.concentrationscale(link.flow.labelConcentration));\n                    }\n                }\n            }\n\n            // Gather statistics of all links at current node\n            var totalOutflow = 0;\n            for(j = 0; j < node.sourceLinks.length; j++) {\n                totalOutflow += node.sourceLinks[j].value;\n            }\n            for(j = 0; j < node.sourceLinks.length; j++) {\n                link = node.sourceLinks[j];\n                link.concentrationOut = link.value / totalOutflow;\n            }\n\n            var totalInflow = 0;\n            for(j = 0; j < node.targetLinks.length; j++) {\n                totalInflow += node.targetLinks[j].value;\n            }\n\n            for(j = 0; j < node.targetLinks.length; j++) {\n                link = node.targetLinks[j];\n                link.concenrationIn = link.value / totalInflow;\n            }\n        }\n    }\n    computeLinkConcentrations();\n\n    // Push any overlapping nodes down.\n    function resolveCollisionsTopToBottom(columns) {\n        columns.forEach(function(nodes) {\n            var node;\n            var dy;\n            var y = 0;\n            var n = nodes.length;\n            var i;\n            nodes.sort(function(a, b) {\n                return a.y0 - b.y0;\n            });\n            for(i = 0; i < n; ++i) {\n                node = nodes[i];\n                if(node.y0 >= y) {\n                    // No overlap\n                } else {\n                    dy = (y - node.y0);\n                    if(dy > 1e-6) node.y0 += dy, node.y1 += dy;\n                }\n                y = node.y1 + nodePad;\n            }\n        });\n    }\n\n    // Group nodes into columns based on their x position\n    function snapToColumns(nodes) {\n        // Sort nodes by x position\n        var orderedNodes = nodes.map(function(n, i) {\n            return {\n                x0: n.x0,\n                index: i\n            };\n        })\n        .sort(function(a, b) {\n            return a.x0 - b.x0;\n        });\n\n        var columns = [];\n        var colNumber = -1;\n        var colX; // Position of column\n        var lastX = -Infinity; // Position of last node\n        var dx;\n        for(i = 0; i < orderedNodes.length; i++) {\n            var node = nodes[orderedNodes[i].index];\n            // If the node does not overlap with the last one\n            if(node.x0 > lastX + nodeThickness) {\n                // Start a new column\n                colNumber += 1;\n                colX = node.x0;\n            }\n            lastX = node.x0;\n\n            // Add node to its associated column\n            if(!columns[colNumber]) columns[colNumber] = [];\n            columns[colNumber].push(node);\n\n            // Change node's x position to align it with its column\n            dx = colX - node.x0;\n            node.x0 += dx, node.x1 += dx;\n        }\n        return columns;\n    }\n\n    // Force node position\n    if(trace.node.x.length && trace.node.y.length) {\n        for(i = 0; i < Math.min(trace.node.x.length, trace.node.y.length, graph.nodes.length); i++) {\n            if(trace.node.x[i] && trace.node.y[i]) {\n                var pos = [trace.node.x[i] * width, trace.node.y[i] * height];\n                graph.nodes[i].x0 = pos[0] - nodeThickness / 2;\n                graph.nodes[i].x1 = pos[0] + nodeThickness / 2;\n\n                var nodeHeight = graph.nodes[i].y1 - graph.nodes[i].y0;\n                graph.nodes[i].y0 = pos[1] - nodeHeight / 2;\n                graph.nodes[i].y1 = pos[1] + nodeHeight / 2;\n            }\n        }\n        if(trace.arrangement === 'snap') {\n            nodes = graph.nodes;\n            var columns = snapToColumns(nodes);\n            resolveCollisionsTopToBottom(columns);\n        }\n        // Update links\n        sankey.update(graph);\n    }\n\n\n    return {\n        circular: circular,\n        key: traceIndex,\n        trace: trace,\n        guid: Lib.randstr(),\n        horizontal: horizontal,\n        width: width,\n        height: height,\n        nodePad: trace.node.pad,\n        nodeLineColor: trace.node.line.color,\n        nodeLineWidth: trace.node.line.width,\n        linkLineColor: trace.link.line.color,\n        linkLineWidth: trace.link.line.width,\n        linkArrowLength: trace.link.arrowlen,\n        valueFormat: trace.valueformat,\n        valueSuffix: trace.valuesuffix,\n        textFont: trace.textfont,\n        translateX: domain.x[0] * layout.width + layout.margin.l,\n        translateY: layout.height - domain.y[1] * layout.height + layout.margin.t,\n        dragParallel: horizontal ? height : width,\n        dragPerpendicular: horizontal ? width : height,\n        arrangement: trace.arrangement,\n        sankey: sankey,\n        graph: graph,\n        forceLayouts: {},\n        interactionState: {\n            dragInProgress: false,\n            hovered: false\n        }\n    };\n}\n\nfunction linkModel(d, l, i) {\n    var tc = tinycolor(l.color);\n    var basicKey = l.source.label + '|' + l.target.label;\n    var key = basicKey + '__' + i;\n\n    // for event data\n    l.trace = d.trace;\n    l.curveNumber = d.trace.index;\n\n    return {\n        circular: d.circular,\n        key: key,\n        traceId: d.key,\n        pointNumber: l.pointNumber,\n        link: l,\n        tinyColorHue: Color.tinyRGB(tc),\n        tinyColorAlpha: tc.getAlpha(),\n        linkPath: linkPath,\n        linkLineColor: d.linkLineColor,\n        linkLineWidth: d.linkLineWidth,\n        linkArrowLength: d.linkArrowLength,\n        valueFormat: d.valueFormat,\n        valueSuffix: d.valueSuffix,\n        sankey: d.sankey,\n        parent: d,\n        interactionState: d.interactionState,\n        flow: l.flow\n    };\n}\n\nfunction createCircularClosedPathString(link, arrowLen) {\n    // Using coordinates computed by d3-sankey-circular\n    var pathString = '';\n    var offset = link.width / 2;\n    var coords = link.circularPathData;\n    if(link.circularLinkType === 'top') {\n        // Top path\n        pathString =\n          // start at the left of the target node\n          'M ' +\n          (coords.targetX - arrowLen) + ' ' + (coords.targetY + offset) + ' ' +\n          'L' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY + offset) +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 1 ' +\n          (coords.rightFullExtent - offset - arrowLen) + ' ' + (coords.targetY - coords.rightSmallArcRadius) +\n          'L' +\n          (coords.rightFullExtent - offset - arrowLen) + ' ' + coords.verticalRightInnerExtent +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 1 ' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent - offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 1 ' +\n          (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent +\n          'L' +\n          (coords.leftFullExtent + offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 1 ' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY + offset) +\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY + offset) +\n\n          // Walking back\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY - offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY - offset) +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 0 ' +\n          (coords.leftFullExtent - offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) +\n          'L' +\n          (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 0 ' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) +\n          'L' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent + offset) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 0 ' +\n          (coords.rightFullExtent + offset - arrowLen) + ' ' + coords.verticalRightInnerExtent +\n          'L' +\n          (coords.rightFullExtent + offset - arrowLen) + ' ' + (coords.targetY - coords.rightSmallArcRadius) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 0 ' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY - offset) +\n          'L' +\n          (coords.targetX - arrowLen) + ' ' + (coords.targetY - offset) +\n          (arrowLen > 0 ? 'L' + coords.targetX + ' ' + (coords.targetY) : '') +\n          'Z';\n    } else {\n        // Bottom path\n        pathString =\n          // start at the left of the target node\n          'M ' +\n          (coords.targetX - arrowLen) + ' ' + (coords.targetY - offset) + ' ' +\n          'L' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY - offset) +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 0 ' +\n          (coords.rightFullExtent - offset - arrowLen) + ' ' + (coords.targetY + coords.rightSmallArcRadius) +\n          'L' +\n          (coords.rightFullExtent - offset - arrowLen) + ' ' + coords.verticalRightInnerExtent +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 0 ' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent + offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 0 ' +\n          (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent +\n          'L' +\n          (coords.leftFullExtent + offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 0 ' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY - offset) +\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY - offset) +\n\n          // Walking back\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY + offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY + offset) +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 1 ' +\n          (coords.leftFullExtent - offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) +\n          'L' +\n          (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 1 ' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) +\n          'L' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent - offset) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 1 ' +\n          (coords.rightFullExtent + offset - arrowLen) + ' ' + coords.verticalRightInnerExtent +\n          'L' +\n          (coords.rightFullExtent + offset - arrowLen) + ' ' + (coords.targetY + coords.rightSmallArcRadius) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 1 ' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY + offset) +\n          'L' +\n          (coords.targetX - arrowLen) + ' ' + (coords.targetY + offset) +\n          (arrowLen > 0 ? 'L' + coords.targetX + ' ' + (coords.targetY) : '') +\n          'Z';\n    }\n    return pathString;\n}\n\nfunction linkPath() {\n    var curvature = 0.5;\n    function path(d) {\n        var arrowLen = d.linkArrowLength;\n        if(d.link.circular) {\n            return createCircularClosedPathString(d.link, arrowLen);\n        } else {\n            var maxArrowLength = Math.abs((d.link.target.x0 - d.link.source.x1) / 2);\n            if(arrowLen > maxArrowLength) {\n                arrowLen = maxArrowLength;\n            }\n            var x0 = d.link.source.x1;\n            var x1 = d.link.target.x0 - arrowLen;\n            var xi = interpolateNumber(x0, x1);\n            var x2 = xi(curvature);\n            var x3 = xi(1 - curvature);\n            var y0a = d.link.y0 - d.link.width / 2;\n            var y0b = d.link.y0 + d.link.width / 2;\n            var y1a = d.link.y1 - d.link.width / 2;\n            var y1b = d.link.y1 + d.link.width / 2;\n            var start = 'M' + x0 + ',' + y0a;\n            var upperCurve = 'C' + x2 + ',' + y0a +\n                ' ' + x3 + ',' + y1a +\n                ' ' + x1 + ',' + y1a;\n            var lowerCurve = 'C' + x3 + ',' + y1b +\n                ' ' + x2 + ',' + y0b +\n                ' ' + x0 + ',' + y0b;\n\n            var rightEnd = arrowLen > 0 ? 'L' + (x1 + arrowLen) + ',' + (y1a + d.link.width / 2) : '';\n            rightEnd += 'L' + x1 + ',' + y1b;\n            return start + upperCurve + rightEnd + lowerCurve + 'Z';\n        }\n    }\n    return path;\n}\n\nfunction nodeModel(d, n) {\n    var tc = tinycolor(n.color);\n    var zoneThicknessPad = c.nodePadAcross;\n    var zoneLengthPad = d.nodePad / 2;\n    n.dx = n.x1 - n.x0;\n    n.dy = n.y1 - n.y0;\n    var visibleThickness = n.dx;\n    var visibleLength = Math.max(0.5, n.dy);\n\n    var key = 'node_' + n.pointNumber;\n    // If it's a group, it's mutable and should be unique\n    if(n.group) {\n        key = Lib.randstr();\n    }\n\n    // for event data\n    n.trace = d.trace;\n    n.curveNumber = d.trace.index;\n\n    return {\n        index: n.pointNumber,\n        key: key,\n        partOfGroup: n.partOfGroup || false,\n        group: n.group,\n        traceId: d.key,\n        trace: d.trace,\n        node: n,\n        nodePad: d.nodePad,\n        nodeLineColor: d.nodeLineColor,\n        nodeLineWidth: d.nodeLineWidth,\n        textFont: d.textFont,\n        size: d.horizontal ? d.height : d.width,\n        visibleWidth: Math.ceil(visibleThickness),\n        visibleHeight: visibleLength,\n        zoneX: -zoneThicknessPad,\n        zoneY: -zoneLengthPad,\n        zoneWidth: visibleThickness + 2 * zoneThicknessPad,\n        zoneHeight: visibleLength + 2 * zoneLengthPad,\n        labelY: d.horizontal ? n.dy / 2 + 1 : n.dx / 2 + 1,\n        left: n.originalLayer === 1,\n        sizeAcross: d.width,\n        forceLayouts: d.forceLayouts,\n        horizontal: d.horizontal,\n        darkBackground: tc.getBrightness() <= 128,\n        tinyColorHue: Color.tinyRGB(tc),\n        tinyColorAlpha: tc.getAlpha(),\n        valueFormat: d.valueFormat,\n        valueSuffix: d.valueSuffix,\n        sankey: d.sankey,\n        graph: d.graph,\n        arrangement: d.arrangement,\n        uniqueNodeLabelPathId: [d.guid, d.key, key].join('_'),\n        interactionState: d.interactionState,\n        figure: d\n    };\n}\n\n// rendering snippets\n\nfunction updateNodePositions(sankeyNode) {\n    sankeyNode\n        .attr('transform', function(d) {\n            return strTranslate(d.node.x0.toFixed(3), (d.node.y0).toFixed(3));\n        });\n}\n\nfunction updateNodeShapes(sankeyNode) {\n    sankeyNode.call(updateNodePositions);\n}\n\nfunction updateShapes(sankeyNode, sankeyLink) {\n    sankeyNode.call(updateNodeShapes);\n    sankeyLink.attr('d', linkPath());\n}\n\nfunction sizeNode(rect) {\n    rect\n      .attr('width', function(d) {return d.node.x1 - d.node.x0;})\n      .attr('height', function(d) {return d.visibleHeight;});\n}\n\nfunction salientEnough(d) {return (d.link.width > 1 || d.linkLineWidth > 0);}\n\nfunction sankeyTransform(d) {\n    var offset = strTranslate(d.translateX, d.translateY);\n    return offset + (d.horizontal ? 'matrix(1 0 0 1 0 0)' : 'matrix(0 1 1 0 0 0)');\n}\n\n// event handling\n\nfunction attachPointerEvents(selection, sankey, eventSet) {\n    selection\n        .on('.basic', null) // remove any preexisting handlers\n        .on('mouseover.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.hover(this, d, sankey);\n                d.interactionState.hovered = [this, d];\n            }\n        })\n        .on('mousemove.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.follow(this, d);\n                d.interactionState.hovered = [this, d];\n            }\n        })\n        .on('mouseout.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.unhover(this, d, sankey);\n                d.interactionState.hovered = false;\n            }\n        })\n        .on('click.basic', function(d) {\n            if(d.interactionState.hovered) {\n                eventSet.unhover(this, d, sankey);\n                d.interactionState.hovered = false;\n            }\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.select(this, d, sankey);\n            }\n        });\n}\n\nfunction attachDragHandler(sankeyNode, sankeyLink, callbacks, gd) {\n    var dragBehavior = d3.behavior.drag()\n        .origin(function(d) {\n            return {\n                x: d.node.x0 + d.visibleWidth / 2,\n                y: d.node.y0 + d.visibleHeight / 2\n            };\n        })\n\n        .on('dragstart', function(d) {\n            if(d.arrangement === 'fixed') return;\n            Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'dragcover', function(s) {\n                gd._fullLayout._dragCover = s;\n            });\n            Lib.raiseToTop(this);\n            d.interactionState.dragInProgress = d.node;\n\n            saveCurrentDragPosition(d.node);\n            if(d.interactionState.hovered) {\n                callbacks.nodeEvents.unhover.apply(0, d.interactionState.hovered);\n                d.interactionState.hovered = false;\n            }\n            if(d.arrangement === 'snap') {\n                var forceKey = d.traceId + '|' + d.key;\n                if(d.forceLayouts[forceKey]) {\n                    d.forceLayouts[forceKey].alpha(1);\n                } else { // make a forceLayout if needed\n                    attachForce(sankeyNode, forceKey, d, gd);\n                }\n                startForce(sankeyNode, sankeyLink, d, forceKey, gd);\n            }\n        })\n\n        .on('drag', function(d) {\n            if(d.arrangement === 'fixed') return;\n            var x = d3.event.x;\n            var y = d3.event.y;\n            if(d.arrangement === 'snap') {\n                d.node.x0 = x - d.visibleWidth / 2;\n                d.node.x1 = x + d.visibleWidth / 2;\n                d.node.y0 = y - d.visibleHeight / 2;\n                d.node.y1 = y + d.visibleHeight / 2;\n            } else {\n                if(d.arrangement === 'freeform') {\n                    d.node.x0 = x - d.visibleWidth / 2;\n                    d.node.x1 = x + d.visibleWidth / 2;\n                }\n                y = Math.max(0, Math.min(d.size - d.visibleHeight / 2, y));\n                d.node.y0 = y - d.visibleHeight / 2;\n                d.node.y1 = y + d.visibleHeight / 2;\n            }\n\n            saveCurrentDragPosition(d.node);\n            if(d.arrangement !== 'snap') {\n                d.sankey.update(d.graph);\n                updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n            }\n        })\n\n        .on('dragend', function(d) {\n            if(d.arrangement === 'fixed') return;\n            d.interactionState.dragInProgress = false;\n            for(var i = 0; i < d.node.childrenNodes.length; i++) {\n                d.node.childrenNodes[i].x = d.node.x;\n                d.node.childrenNodes[i].y = d.node.y;\n            }\n            if(d.arrangement !== 'snap') persistFinalNodePositions(d, gd);\n        });\n\n    sankeyNode\n        .on('.drag', null) // remove possible previous handlers\n        .call(dragBehavior);\n}\n\nfunction attachForce(sankeyNode, forceKey, d, gd) {\n    // Attach force to nodes in the same column (same x coordinate)\n    switchToForceFormat(d.graph.nodes);\n    var nodes = d.graph.nodes\n        .filter(function(n) {return n.originalX === d.node.originalX;})\n        // Filter out children\n        .filter(function(n) {return !n.partOfGroup;});\n    d.forceLayouts[forceKey] = d3Force.forceSimulation(nodes)\n        .alphaDecay(0)\n        .force('collide', d3Force.forceCollide()\n            .radius(function(n) {return n.dy / 2 + d.nodePad / 2;})\n            .strength(1)\n            .iterations(c.forceIterations))\n        .force('constrain', snappingForce(sankeyNode, forceKey, nodes, d, gd))\n        .stop();\n}\n\nfunction startForce(sankeyNode, sankeyLink, d, forceKey, gd) {\n    window.requestAnimationFrame(function faster() {\n        var i;\n        for(i = 0; i < c.forceTicksPerFrame; i++) {\n            d.forceLayouts[forceKey].tick();\n        }\n\n        var nodes = d.graph.nodes;\n        switchToSankeyFormat(nodes);\n\n        d.sankey.update(d.graph);\n        updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n\n        if(d.forceLayouts[forceKey].alpha() > 0) {\n            window.requestAnimationFrame(faster);\n        } else {\n            // Make sure the final x position is equal to its original value\n            // because the force simulation will have numerical error\n            var x = d.node.originalX;\n            d.node.x0 = x - d.visibleWidth / 2;\n            d.node.x1 = x + d.visibleWidth / 2;\n\n            persistFinalNodePositions(d, gd);\n        }\n    });\n}\n\nfunction snappingForce(sankeyNode, forceKey, nodes, d) {\n    return function _snappingForce() {\n        var maxVelocity = 0;\n        for(var i = 0; i < nodes.length; i++) {\n            var n = nodes[i];\n            if(n === d.interactionState.dragInProgress) { // constrain node position to the dragging pointer\n                n.x = n.lastDraggedX;\n                n.y = n.lastDraggedY;\n            } else {\n                n.vx = (n.originalX - n.x) / c.forceTicksPerFrame; // snap to layer\n                n.y = Math.min(d.size - n.dy / 2, Math.max(n.dy / 2, n.y)); // constrain to extent\n            }\n            maxVelocity = Math.max(maxVelocity, Math.abs(n.vx), Math.abs(n.vy));\n        }\n        if(!d.interactionState.dragInProgress && maxVelocity < 0.1 && d.forceLayouts[forceKey].alpha() > 0) {\n            d.forceLayouts[forceKey].alpha(0); // This will stop the animation loop\n        }\n    };\n}\n\n// basic data utilities\n\nfunction persistFinalNodePositions(d, gd) {\n    var x = [];\n    var y = [];\n    for(var i = 0; i < d.graph.nodes.length; i++) {\n        var nodeX = (d.graph.nodes[i].x0 + d.graph.nodes[i].x1) / 2;\n        var nodeY = (d.graph.nodes[i].y0 + d.graph.nodes[i].y1) / 2;\n        x.push(nodeX / d.figure.width);\n        y.push(nodeY / d.figure.height);\n    }\n    Registry.call('_guiRestyle', gd, {\n        'node.x': [x],\n        'node.y': [y]\n    }, d.trace.index)\n    .then(function() {\n        if(gd._fullLayout._dragCover) gd._fullLayout._dragCover.remove();\n    });\n}\n\nfunction persistOriginalPlace(nodes) {\n    var distinctLayerPositions = [];\n    var i;\n    for(i = 0; i < nodes.length; i++) {\n        nodes[i].originalX = (nodes[i].x0 + nodes[i].x1) / 2;\n        nodes[i].originalY = (nodes[i].y0 + nodes[i].y1) / 2;\n        if(distinctLayerPositions.indexOf(nodes[i].originalX) === -1) {\n            distinctLayerPositions.push(nodes[i].originalX);\n        }\n    }\n    distinctLayerPositions.sort(function(a, b) {return a - b;});\n    for(i = 0; i < nodes.length; i++) {\n        nodes[i].originalLayerIndex = distinctLayerPositions.indexOf(nodes[i].originalX);\n        nodes[i].originalLayer = nodes[i].originalLayerIndex / (distinctLayerPositions.length - 1);\n    }\n}\n\nfunction saveCurrentDragPosition(d) {\n    d.lastDraggedX = d.x0 + d.dx / 2;\n    d.lastDraggedY = d.y0 + d.dy / 2;\n}\n\nfunction sameLayer(d) {\n    return function(n) {return n.node.originalX === d.node.originalX;};\n}\n\nfunction switchToForceFormat(nodes) {\n    // force uses x, y as centers\n    for(var i = 0; i < nodes.length; i++) {\n        nodes[i].y = (nodes[i].y0 + nodes[i].y1) / 2;\n        nodes[i].x = (nodes[i].x0 + nodes[i].x1) / 2;\n    }\n}\n\nfunction switchToSankeyFormat(nodes) {\n    // sankey uses x0, x1, y0, y1\n    for(var i = 0; i < nodes.length; i++) {\n        nodes[i].y0 = nodes[i].y - nodes[i].dy / 2;\n        nodes[i].y1 = nodes[i].y0 + nodes[i].dy;\n\n        nodes[i].x0 = nodes[i].x - nodes[i].dx / 2;\n        nodes[i].x1 = nodes[i].x0 + nodes[i].dx;\n    }\n}\n\n// scene graph\nmodule.exports = function(gd, svg, calcData, layout, callbacks) {\n    var isStatic = gd._context.staticPlot;\n\n    // To prevent animation on first render\n    var firstRender = false;\n    Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'first-render', function() {\n        firstRender = true;\n    });\n\n    // To prevent animation on dragging\n    var dragcover = gd._fullLayout._dragCover;\n\n    var styledData = calcData\n            .filter(function(d) {return unwrap(d).trace.visible;})\n            .map(sankeyModel.bind(null, layout));\n\n    var sankey = svg.selectAll('.' + c.cn.sankey)\n        .data(styledData, keyFun);\n\n    sankey.exit()\n        .remove();\n\n    sankey.enter()\n        .append('g')\n        .classed(c.cn.sankey, true)\n        .style('box-sizing', 'content-box')\n        .style('position', 'absolute')\n        .style('left', 0)\n        .style('shape-rendering', 'geometricPrecision')\n        .style('pointer-events', isStatic ? 'none' : 'auto')\n        .attr('transform', sankeyTransform);\n\n    sankey.each(function(d, i) {\n        gd._fullData[i]._sankey = d;\n        // Create dragbox if missing\n        var dragboxClassName = 'bgsankey-' + d.trace.uid + '-' + i;\n        Lib.ensureSingle(gd._fullLayout._draggers, 'rect', dragboxClassName);\n\n        gd._fullData[i]._bgRect = d3.select('.' + dragboxClassName);\n\n        // Style dragbox\n        gd._fullData[i]._bgRect\n          .style('pointer-events', isStatic ? 'none' : 'all')\n          .attr('width', d.width)\n          .attr('height', d.height)\n          .attr('x', d.translateX)\n          .attr('y', d.translateY)\n          .classed('bgsankey', true)\n          .style({fill: 'transparent', 'stroke-width': 0});\n    });\n\n    sankey.transition()\n        .ease(c.ease).duration(c.duration)\n        .attr('transform', sankeyTransform);\n\n    var sankeyLinks = sankey.selectAll('.' + c.cn.sankeyLinks)\n        .data(repeat, keyFun);\n\n    sankeyLinks.enter()\n        .append('g')\n        .classed(c.cn.sankeyLinks, true)\n        .style('fill', 'none');\n\n    var sankeyLink = sankeyLinks.selectAll('.' + c.cn.sankeyLink)\n          .data(function(d) {\n              var links = d.graph.links;\n              return links\n                .filter(function(l) {return l.value;})\n                .map(linkModel.bind(null, d));\n          }, keyFun);\n\n    sankeyLink\n          .enter().append('path')\n          .classed(c.cn.sankeyLink, true)\n          .call(attachPointerEvents, sankey, callbacks.linkEvents);\n\n    sankeyLink\n        .style('stroke', function(d) {\n            return salientEnough(d) ? Color.tinyRGB(tinycolor(d.linkLineColor)) : d.tinyColorHue;\n        })\n        .style('stroke-opacity', function(d) {\n            return salientEnough(d) ? Color.opacity(d.linkLineColor) : d.tinyColorAlpha;\n        })\n        .style('fill', function(d) {\n            return d.tinyColorHue;\n        })\n        .style('fill-opacity', function(d) {\n            return d.tinyColorAlpha;\n        })\n        .style('stroke-width', function(d) {\n            return salientEnough(d) ? d.linkLineWidth : 1;\n        })\n        .attr('d', linkPath());\n\n    sankeyLink\n        .style('opacity', function() { return (gd._context.staticPlot || firstRender || dragcover) ? 1 : 0;})\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 1);\n\n    sankeyLink.exit()\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 0)\n        .remove();\n\n    var sankeyNodeSet = sankey.selectAll('.' + c.cn.sankeyNodeSet)\n        .data(repeat, keyFun);\n\n    sankeyNodeSet.enter()\n        .append('g')\n        .classed(c.cn.sankeyNodeSet, true);\n\n    sankeyNodeSet\n        .style('cursor', function(d) {\n            switch(d.arrangement) {\n                case 'fixed': return 'default';\n                case 'perpendicular': return 'ns-resize';\n                default: return 'move';\n            }\n        });\n\n    var sankeyNode = sankeyNodeSet.selectAll('.' + c.cn.sankeyNode)\n        .data(function(d) {\n            var nodes = d.graph.nodes;\n            persistOriginalPlace(nodes);\n            return nodes\n              .map(nodeModel.bind(null, d));\n        }, keyFun);\n\n    sankeyNode.enter()\n        .append('g')\n        .classed(c.cn.sankeyNode, true)\n        .call(updateNodePositions)\n        .style('opacity', function(n) { return ((gd._context.staticPlot || firstRender) && !n.partOfGroup) ? 1 : 0;});\n\n    sankeyNode\n        .call(attachPointerEvents, sankey, callbacks.nodeEvents)\n        .call(attachDragHandler, sankeyLink, callbacks, gd); // has to be here as it binds sankeyLink\n\n    sankeyNode\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .call(updateNodePositions)\n        .style('opacity', function(n) { return n.partOfGroup ? 0 : 1;});\n\n    sankeyNode.exit()\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 0)\n        .remove();\n\n    var nodeRect = sankeyNode.selectAll('.' + c.cn.nodeRect)\n        .data(repeat);\n\n    nodeRect.enter()\n        .append('rect')\n        .classed(c.cn.nodeRect, true)\n        .call(sizeNode);\n\n    nodeRect\n        .style('stroke-width', function(d) {return d.nodeLineWidth;})\n        .style('stroke', function(d) {return Color.tinyRGB(tinycolor(d.nodeLineColor));})\n        .style('stroke-opacity', function(d) {return Color.opacity(d.nodeLineColor);})\n        .style('fill', function(d) {return d.tinyColorHue;})\n        .style('fill-opacity', function(d) {return d.tinyColorAlpha;});\n\n    nodeRect.transition()\n        .ease(c.ease).duration(c.duration)\n        .call(sizeNode);\n\n    var nodeLabel = sankeyNode.selectAll('.' + c.cn.nodeLabel)\n        .data(repeat);\n\n    nodeLabel.enter()\n        .append('text')\n        .classed(c.cn.nodeLabel, true)\n        .style('cursor', 'default');\n\n    nodeLabel\n        .attr('data-notex', 1) // prohibit tex interpretation until we can handle tex and regular text together\n        .text(function(d) { return d.node.label; })\n        .each(function(d) {\n            var e = d3.select(this);\n            Drawing.font(e, d.textFont);\n            svgTextUtils.convertToTspans(e, gd);\n        })\n        .style('text-shadow', svgTextUtils.makeTextShadow(gd._fullLayout.paper_bgcolor))\n        .attr('text-anchor', function(d) {\n            return (d.horizontal && d.left) ? 'end' : 'start';\n        })\n        .attr('transform', function(d) {\n            var e = d3.select(this);\n            // how much to shift a multi-line label to center it vertically.\n            var nLines = svgTextUtils.lineCount(e);\n            var blockHeight = d.textFont.size * (\n                (nLines - 1) * LINE_SPACING - CAP_SHIFT\n            );\n\n            var posX = d.nodeLineWidth / 2 + TEXTPAD;\n            var posY = ((d.horizontal ? d.visibleHeight : d.visibleWidth) - blockHeight) / 2;\n            if(d.horizontal) {\n                if(d.left) {\n                    posX = -posX;\n                } else {\n                    posX += d.visibleWidth;\n                }\n            }\n\n            var flipText = d.horizontal ? '' : (\n                'scale(-1,1)' + strRotate(90)\n            );\n\n            return strTranslate(\n                d.horizontal ? posX : posY,\n                d.horizontal ? posY : posX\n            ) + flipText;\n        });\n\n    nodeLabel\n        .transition()\n        .ease(c.ease).duration(c.duration);\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}