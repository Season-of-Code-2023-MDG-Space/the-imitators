{"ast":null,"code":"var util = require('util');\nvar Promise = require('bluebird');\nvar _ = require('lodash');\nvar debug = require('debug')('yahoo-finance:yahooCrumb');\nvar _constants = require('./constants');\nvar _utils = require('./utils');\n\n// Faster but probably more brittle option:\n// var crumbRE = /\"CrumbStore\":\\{\"crumb\":\"(.+?)\"\\}/;\n\nvar dataRE = /^root.App.main = (\\{.*\\});$/m;\nfunction parseAndGetCrumb(body) {\n  var match = dataRE.exec(body);\n  if (!match) {\n    throw new Error(\"Could not match root.App.main line.  If this happens \" + \"consistently, Yahoo output has changed and you should open a bug \" + \"report.\");\n  }\n  var data;\n  try {\n    data = JSON.parse(match[1]);\n  } catch (err) {\n    console.error(err);\n    throw new Error(\"root.App.main line (or regexp) did not capture valid \" + \"JSON.  If this happens consistently, please open a bug report.\");\n  }\n  var crumb;\n  if (!data.context) throw new Error(\"root.Api.main JSON structure has changed.  If this \" + \"happens consistently, please open a bug report.\");\n  var dispatcher = data.context.dispatcher;\n  crumb = dispatcher && dispatcher.stores && dispatcher.stores.CrumbStore && dispatcher.stores.CrumbStore.crumb;\n  if (!crumb) {\n    console.warn('root.Api.main context.dispatcher.stores.CrumbStore.crumb ' + 'structure no longer exists, please open an issue.');\n    var plugins = data.context.plugins;\n    crumb = plugins && plugins.ServicePlugin && plugins.ServicePlugin.xhrContext && plugins.ServicePlugin.xhrContext.crumb;\n    if (!crumb) throw new Error('root.Api.main ' + 'context.plugins.ServicePlugin.xhrContext.crumb' + 'structure no longer exists, please open an issue.');\n  }\n  return crumb;\n}\nvar crumb = null;\nvar rpOpts = {\n  resolveWithFullResponse: true\n};\nfunction fetch(symbol) {\n  var url = _constants.HISTORICAL_CRUMB_URL.replace(/\\$SYMBOL/, symbol);\n  return _utils.download(url, '', rpOpts).then(function (res) {\n    crumb = parseAndGetCrumb(res.body);\n    return crumb;\n  }).catch(function (err) {\n    throw new Error(util.format('Failed to get crumb (%s)', err.message));\n  });\n}\nfunction getCrumb(symbol) {\n  // Invalidate the crumb if the cookie is expired.\n  if (crumb) {\n    // Note: getCookies() won't return expired cookies and we rely on this.\n    var cookies = _utils.cookiejar.getCookies(_constants.HISTORICAL_CRUMB_URL);\n    var bCookie = _.find(cookies, {\n      key: 'B'\n    });\n    if (!bCookie) {\n      debug('No valid cookies, invalidating crumb');\n      crumb = null;\n    }\n  }\n  if (crumb) {\n    debug('Returning cached crumb');\n    return Promise.resolve(crumb);\n  } else {\n    debug('Fetching a new cookie & crumb');\n    return fetch(symbol).then(function (crumb) {\n      return crumb;\n    });\n  }\n}\n\n// API\nexports.getCrumb = getCrumb;\n\n// for testing\nexports.parseAndGetCrumb = parseAndGetCrumb;","map":{"version":3,"names":["util","require","Promise","_","debug","_constants","_utils","dataRE","parseAndGetCrumb","body","match","exec","Error","data","JSON","parse","err","console","error","crumb","context","dispatcher","stores","CrumbStore","warn","plugins","ServicePlugin","xhrContext","rpOpts","resolveWithFullResponse","fetch","symbol","url","HISTORICAL_CRUMB_URL","replace","download","then","res","catch","format","message","getCrumb","cookies","cookiejar","getCookies","bCookie","find","key","resolve","exports"],"sources":["/Users/lordvoldemort/IdeaProjects/Webdevelopment/Bulls and Bears/bull_bear/node_modules/yahoo-finance/lib/yahooCrumb.js"],"sourcesContent":["var util = require('util');\n\nvar Promise = require('bluebird');\nvar _ = require('lodash');\nvar debug = require('debug')('yahoo-finance:yahooCrumb');\n\nvar _constants = require('./constants');\nvar _utils = require('./utils');\n\n// Faster but probably more brittle option:\n// var crumbRE = /\"CrumbStore\":\\{\"crumb\":\"(.+?)\"\\}/;\n\nvar dataRE = /^root.App.main = (\\{.*\\});$/m;\nfunction parseAndGetCrumb(body) {\n  var match = dataRE.exec(body);\n  if (!match) {\n    throw new Error(\"Could not match root.App.main line.  If this happens \" +\n      \"consistently, Yahoo output has changed and you should open a bug \" +\n      \"report.\");\n  }\n\n  var data;\n  try {\n    data = JSON.parse(match[1]);\n  } catch (err) {\n    console.error(err);\n    throw new Error(\"root.App.main line (or regexp) did not capture valid \" +\n      \"JSON.  If this happens consistently, please open a bug report.\");\n  }\n\n  var crumb;\n  if (!data.context)\n    throw new Error(\"root.Api.main JSON structure has changed.  If this \" +\n      \"happens consistently, please open a bug report.\");\n\n  var dispatcher = data.context.dispatcher;\n  crumb = dispatcher &&\n    dispatcher.stores &&\n    dispatcher.stores.CrumbStore &&\n    dispatcher.stores.CrumbStore.crumb;\n\n  if (!crumb) {\n    console.warn('root.Api.main context.dispatcher.stores.CrumbStore.crumb ' +\n      'structure no longer exists, please open an issue.');\n\n    var plugins = data.context.plugins;\n    crumb = plugins &&\n      plugins.ServicePlugin &&\n      plugins.ServicePlugin.xhrContext &&\n      plugins.ServicePlugin.xhrContext.crumb;\n\n    if (!crumb)\n      throw new Error('root.Api.main ' +\n        'context.plugins.ServicePlugin.xhrContext.crumb' +\n        'structure no longer exists, please open an issue.')\n  }\n\n  return crumb;\n}\n\nvar crumb = null;\nvar rpOpts = { resolveWithFullResponse: true };\n\nfunction fetch(symbol) {\n  var url = _constants.HISTORICAL_CRUMB_URL.replace(/\\$SYMBOL/, symbol);\n  return _utils.download(url, '', rpOpts)\n    .then(function (res) {\n      crumb = parseAndGetCrumb(res.body);\n      return crumb;\n    })\n    .catch(function(err){\n      throw new Error(util.format('Failed to get crumb (%s)', err.message));\n    });\n}\n\nfunction getCrumb(symbol) {\n  // Invalidate the crumb if the cookie is expired.\n  if (crumb) {\n    // Note: getCookies() won't return expired cookies and we rely on this.\n    var cookies = _utils.cookiejar.getCookies(_constants.HISTORICAL_CRUMB_URL);\n    var bCookie = _.find(cookies, { key: 'B' });\n    if (!bCookie) {\n      debug('No valid cookies, invalidating crumb');\n      crumb = null;\n    }\n  }\n\n  if (crumb) {\n    debug('Returning cached crumb');\n    return Promise.resolve(crumb);\n  } else {\n    debug('Fetching a new cookie & crumb');\n    return fetch(symbol).then(function(crumb) { return crumb; })\n  }\n}\n\n// API\nexports.getCrumb = getCrumb;\n\n// for testing\nexports.parseAndGetCrumb = parseAndGetCrumb;\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}